# 戦闘システム

変身ヒロインと敵が 1 対 1 で戦うターン制のバトルシミュレーションシステムを開発する

## 満たすべき要求

1. 属性ゲームであり、属性により有利不利がはっきりとわかれる。属性は 火 < 水 < 風 < 火 と 3 すくみの関係にある
2. 変身ヒロインはすぐに敗北しないようにする。変身ヒロインと敵はこの点で非対称性をもつ

- 一般的に出現する雑魚敵（変身ヒロインより弱い・HPと判断力の合計が 70%程度）に対し
  - 有利属性であれば 3 ターン以内程度で変身ヒロインが勝利
  - 同属性であれば 4 ターン以上かかって変身ヒロインが勝利
  - 不利属性でも 5 ターン以上かかって変身ヒロインが勝利（勝負の文で敗北してもよい）
- ボスキャラ（変身ヒロインと同等の強さ・HPと判断力の合計が同程度）に対し
  - 有利属性であれば 4 ターン程度で変身ヒロインが勝利
  - 同属性であれば 5 ターン以上かかって変身ヒロインが勝利（勝負の文で敗北してもよい）
  - 不利属性であれば 3 ターン以上かかってで変身ヒロインが敗北

後述するが、ステータスの体力が攻撃力に直結するので、体力の高いヒロインは比較的短いターンで勝利でき、体力の低いヒロインは勝利までターン数が長くなる。

## 敵に対する制約について

- 要求 2 を満たすため、敵は戦闘開始時点では能力をフルに発揮していないという制約をおく
  - 例えばゲーム開始時点では、敵は 50% しか能力を発揮できない。ターンを経過するごとに 10% ずつ能力が開放され、5 ターン目に 100% 開放される
  - ゲーム内時間が経過すると、1 ターン目から最大 80% 程度まで発揮・3 ターン目で 100%に到達できるように設定でき、敵の開放が進んで行きヒロインが徐々に苦戦するようになるとかが表現できるようになる

## ターンの流れ

1. 開始処理
   1. アクティブスキルの使用（敵へのデバフ付与）

2. 戦闘処理
   1. 現在のステータスの更新（デバフ等によるスタータス補正）
   2. ダメージ計算
   3. パッスブスキルの計算

3. 終了処理
   1. デバフの継続期間の更新

## ステータスの定義

- 体力:
  - HP およびダメージの算出に利用する
- 判断力:
  - 相手の判断力との差によりダメージの軽減処理に利用する
    - これにより体力が低いが判断力が高いというようにキャラクターの個性が表現できる
- 精神力:
  - スキルの防御判定に利用する
- 疲労度:
  - 初期トータルダメージの算出に利用する
    - turn 1 時に初回トータルダメージの計算が最大HP \* 疲労度 / 100 に設定される

### 想定されるキャラクターセッティング

- 高体力・低判断力型（例: 体力 100 / 判断力 20）
  - 基本的に強い
  - 攻撃力が高いが、相手の判断力との関係によってはダメージが減衰するため苦戦する
  - 体力が低いが、相手の判断力との関係によってはダメージが大きくなるため苦戦する
- バランス型（例: 体力 60 / 判断力 60）
  - 実は強い
- 低体力・高判断力型（例: 体力 40 / 判断力 100）
  - 基本的に弱い（体力と判断力の合計が他の型より高くしてバランスを取っている）
  - スキルを盛ることでバランスを取ることを推奨する

## スキルシステム

### アクティブスキル

アクティブスキルは毎ターンの開始前処理で自動的に実行される。
アクティブスキルの結果、相手にデバフを与え、効果はそのターンから適用される。
アクティブスキルの成功率は、攻撃側の判断力 および 守備側の精神力 から計算される。

### パッシブスキル（未実装）

パッシブスキルは毎ターンのダメージ計算処理に介入する。
パッシブスキルの成功率は、攻撃側の判断力 および 守備側の判断力 から計算される。

## デバフ

#### 毒付与

- 効果: 相手に最大HPの10%を毎ターン開始時にダメージとして与える

#### 判断力ダウン

- 効果: 判断力が半減する

### デバフの適用

- デバフの効果は「現在のステータスを計算する」段階で適用される
- 毒のダメージは通常のダメージ算出前に行われる
- 毒により体力が0以下になった場合、攻撃は実行されない
- 毒により体力が0以下になった場合、相手はとどめの攻撃を実行し、このとき判断力によるダメージ軽減は行わない（0として計算される）

## バトルシステムの詳細仕様

- 最大 HP:
  - 体力値に能力開放値をかけて算出する
- 現在 HP:
  - 最大 HP からダメージの合計値を引いたもの。0 以下になると敗北
- 能力解放値:
  - 敵: ターン進行に伴い増加していくよう設定する想定。最大 100%
- 基本ダメージ: 攻撃者の最大 HP の 1/5 を基本ダメージとする（これにより他の要素が影響しなければ 5 ターン程度で決着する）
- 属性相性:
  - 有利属性：攻撃者のダメージが 1.5 倍になる。
  - 苦手属性：攻撃者のダメージが 2/3 倍（約 0.67 倍）になる。
- 判断力の差分によるダメージ軽減:
  - 例：攻撃者 100 守備者 60 の場合攻撃側が上回っているため100%適用
  - 例: 攻撃者 20 守備者 60 の場合、`2 * 20 / (20 + 60)`なので、50%に減衰
  - 例: 攻撃者 20 守備者 100 の場合、 `2 * 20 / (20 + 100)`なので、33%に減衰

## 特殊処理

TODO: 今後設定により on / off できるようにする

1. 無防備な一撃: デバフの処理等により、攻撃前に変身ヒロインのHPが0以下になった場合、判断力を0としてダメージ計算する
