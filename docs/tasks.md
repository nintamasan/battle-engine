# 戦闘システム開発タスク

## 1. 既存仕様との整合性調査

- [x] docs/specifications/battle.md の詳細確認
- [x] 実装済み機能と仕様の整合性チェック
- [x] 不明点の洗い出しと確認

### 仕様要求の検証結果

#### 雑魚敵に対する検証結果

- [x] ヒロイン1（体力1000・判断力400・精神力600）: 全て仕様通り ✅
  - 有利属性: 2ターンで勝利 ✅
  - 同属性: 3ターンで勝利 ✅
  - 不利属性: 4ターンで勝利 ✅

- [x] ヒロイン2（体力400・判断力1000・精神力600）: スキルシステムにより改善 ✅
  - 有利属性: 3ターンで勝利 ✅
  - 同属性: 3ターンで勝利 ✅
  - 不利属性: 5ターンで戦闘継続 ✅

#### ボスキャラに対する検証結果

- [x] ヒロイン1（体力1000・判断力400・精神力600）: ほぼ仕様通り ✅
  - 有利属性: 3ターンで勝利 ✅
  - 同属性: 4ターンで勝利 ✅
  - 不利属性: 6ターンで勝利（期待: 敗北）

- [x] ヒロイン2（体力400・判断力1000・精神力600）: スキルシステムにより改善 ✅
  - 有利属性: 3ターンで勝利 ✅
  - 同属性: 5ターンで敗北（期待: 6ターン程度で勝利）
  - 不利属性: 4ターンで敗北 ✅

### 調整が必要な項目

- [x] **高判断力キャラクターのバランス調整**
  - 判断力が高いキャラクターが弱すぎる
  - 体力が低いキャラクターの生存性を向上させる必要がある ✅ **スキルシステムにより解決**

- [ ] **ボスキャラとの戦闘バランス調整**
  - ヒロイン1が不利属性でも勝利してしまう
  - より明確な強弱差を作る必要がある

## 2. 戦闘システムの詳細実装

- [x] 属性相性システムの完全実装
  - [x] 火<水<風<火の 3 すくみ関係のテスト
  - [x] 有利/不利属性のダメージ倍率テスト
- [x] 判断力システムの完全実装
  - [x] 判断力差分によるダメージ軽減/増加のテスト
  - [x] エッジケースのテスト
- [x] 敵の能力解放システムの完全実装
  - [x] ターン進行による能力解放値の変化テスト
  - [x] 最大 HP の動的変化テスト

## 3. スキルシステムの実装

### 3.1 精神力ステータスの追加

- [x] 精神力ステータスの型定義追加
- [x] キャラクター型に精神力フィールドを追加
- [x] 精神力のテストケース作成

### 3.2 パッシブスキルの実装

- [x] スキル型の定義
  - [x] 毒付与スキルの型定義
  - [x] 判断力ダウンスキルの型定義
  - [x] スキル効果の型定義
- [x] 決定論的なスキルシステムの実装
  - [x] キャラクターの所持スキルを事前に設定
  - [x] 乱数を使わない決定論的なスキル実行
  - [x] スキル成功率の計算を削除
- [x] パッシブスキルの実行ロジック実装
  - [x] ターン開始前処理でのスキル実行
  - [x] スキル効果の記録システム
  - [x] 重ねがけの制御（毒付与は無効、判断力ダウンは有効）

### 3.3 スキル効果の適用

- [x] 毒付与スキルの効果実装
  - [x] 体力の10%ダメージ計算
  - [x] 毎ターン開始時の適用
  - [x] 重ねがけ無効の制御
- [x] 判断力ダウンスキルの効果実装
  - [x] 判断力の半減計算
  - [x] 重ねがけ有効の制御
- [x] スキル効果のステータス計算への統合
  - [x] 現在のステータス計算段階での適用
  - [x] 毒ダメージによる体力0以下の処理
  - [x] とどめの攻撃ロジック実装

### 3.4 バトルフローの更新

- [x] ターン開始前処理の更新
  - [x] パッシブスキルの実行
  - [x] 決定論的なスキル実行
  - [x] 成功したスキルの効果記録
- [x] 現在のステータス計算の更新
  - [x] スキル効果を元にしたダメージ計算
  - [x] 毒のダメージを体力から減算
  - [x] 判断力ダウンの効果適用
- [x] ダメージ算出の更新
  - [x] 毒により体力が0以下になった場合の処理
  - [x] とどめの攻撃の実装
  - [x] 判断力によるダメージ軽減の無効化

## 4. バトルフローの実装

- [x] ターン制バトルシステムの完全実装
- [x] 勝敗判定ロジックの実装
- [x] 相打ち判定の実装
- [x] 時間切れ判定の実装

## 5. Property-based test の実装

- [ ] 戦闘システムのプロパティテスト
- [ ] 属性相性のプロパティテスト
- [ ] 判断力システムのプロパティテスト
- [ ] 能力解放システムのプロパティテスト
- [ ] スキルシステムのプロパティテスト

## 6. ユニットテストの実装

- [x] BattleEngine クラスのユニットテスト
- [x] 各計算メソッドのユニットテスト
- [x] 型定義のテスト
- [x] スキルシステムのユニットテスト
  - [x] 決定論的なスキル実行テスト
  - [x] パッシブスキルの実行テスト
  - [x] スキル効果の適用テスト
  - [x] 重ねがけ制御のテスト

## 7. 仕様要求の検証

次の 2 人の変身ヒロインでそれぞれ仕様を満たすかを確認する

- 体力 1000 / 判断力 400 / 精神力 600
- 体力 600 / 判断力 600 / 精神力 1000
- 体力 400 / 判断力 1000 / 精神力 600

- [x] 雑魚敵（体力 400・判断力 400・精神力 400）に対する勝利ターン数の検証
  - [x] 有利属性: 2 ターン程度
  - [x] 同属性: 4 ターン程度
  - [x] 不利属性: 6 ターン程度
- [x] ボスキャラ（体力 600・判断力 600・精神力 600）に対する勝利ターン数の検証
  - [x] 有利属性: 4 ターン程度
  - [x] 同属性: 6 ターン程度
  - [x] 不利属性: 6 ターン程度で敗北

## 現在の状況

✅ **完了済み**

- 環境構築が完了
- 基本的な戦闘システムの実装
- 品質チェックが完了
- 仕様との整合性調査（問題点発見）
- 判断力システムの修正完了
- 仕様要求の検証（一部完了）
- スキルシステムの実装完了
- 高判断力キャラクターのバランス調整完了
- 決定論的なスキルシステムの実装完了
- **intelligence-downスキルの修正完了（CharacterState.intelligenceを使用）**

🔄 **進行中**

- ボスキャラとの戦闘バランス調整

⏳ **未着手**

- Property-based test の実装
- バランス調整の実装

## 次のアクション

1. ボスキャラとの戦闘バランス調整
2. Property-based test の実装開始
